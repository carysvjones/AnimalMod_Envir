---
title: "prep matrices and compare"
author: "Carys Jones"
date: '2023-01-31'
output: html_document
---

when run models make sure make things factors beforehand

# Dependencies
```{r}



box::use(.. / R / dirs[dirs])
box::use(clean = ../ R / clean_data)
box::use(mod = ../ R / for_models)

box::use(readr[read_csv])
box::use(ggplot2[...])
box::use(dplyr[...])
box::use(moments)
box::use(kinship2)
box::use(sf)
box::use(tidyr)
box::use(magrittr[`%>%`])
box::use(asreml[...])
box::use(Matrix)


```



```{r Read in Data}

gtit_data_sub_nb <- read.csv(file.path(dirs$data_output, 'GTIT_data_anim_mod.csv'), na.strings=c("", "NA"))
nrow(gtit_data_sub_nb) #11661

gtit_data_sub_nb <- gtit_data_sub_nb %>% #don't make breeding year a factor?
   mutate_at(c('breeding_year', 'Mother', 'Fbreeding_age_group', 'nest.box'), as.factor) 

#to run with a subset 
#put dates as range e.g. 2011:2021, or 'ALL' to get all years of data 
breed_data <- gtit_data_sub_nb %>%
  mod$choose_data(gtit_data_sub_nb, years = 'ALL')
unique(breed_data$breeding_year)
nrow(breed_data) #11661

```


```{r Correlation lay and hatch}

box::use(brms[...])

# Fit model
fit <- brm(April.hatch.date ~ April.lay.date,
           data = gtit_data_sub_nb)
plot_slopes(fit, 'April.lay.date')


# Print the summary of the fitted model
summary(fit)
plot(fit)

library(marginaleffects)
plot_slopes(fit,  variables = 'April.lay.date')

mtcars %>%
  data_grid(hp = seq_range(hp, n = 101)) %>%
  # NOTE: this shows the use of ndraws to subsample within add_epred_draws()
  # ONLY do this IF you are planning to make spaghetti plots, etc.
  # NEVER subsample to a small sample to plot intervals, densities, etc.
  tidybayes::add_epred_draws(fit, ndraws = 100) %>%
  ggplot(aes(x = April.lay.date, y = April.hatch.date)) +
  geom_line(aes(y = .epred, alpha = .1)) +
  geom_point(data = gtit_data_sub_nb) +
  scale_color_brewer(palette = "Dark2")


LD_HD_mod <- lm(April.hatch.date ~ April.lay.date,
   data = gtit_data_sub_nb)
summary(LD_HD_mod)
  
effect_plot(LD_HD_mod, pred = displ, interval = TRUE, plot.points = TRUE)

ggplot(gtit_data_sub_nb, aes(x = April.lay.date, y = April.hatch.date)) + 
  geom_smooth(method = 'lm', se = T) + 
  output_plot_theme

```





```{r Prep Ped}

#pedigree data input 
ped_data <- read.csv(file.path(dirs$data_output, 'GTIT-pedigree-for-asreml.csv'), na.strings=c("", "NA"))
nrow(ped_data) #15745

#get inverse of matrix
ped_data_inv <- asreml::ainverse(ped_data)

#create another column to associate with second matrix

breed_data$Mother <- as.factor(breed_data$Mother)
breed_data$Mother2 <- breed_data$Mother

```


```{r Matrices}

env_matrix <- readRDS(file.path(dirs$data_output, 'env_matrix.rds'))

spatial_matrix <- readRDS(file.path(dirs$data_output, 'spatial_matrix.rds'))


```


RUN MODELS ---------------------------------------------------------


```{r Run Models}

# LAYING DATE  ------------------------------------------------------------

#model basic 
LD_basic <- asreml(fixed = April.lay.date ~ 1 + Fbreeding_age_group,
                  random = ~vm(Mother, ped_data_inv) + 
                            ide(Mother, ped_data_inv) +
                            breeding_year,
                  data = breed_data)
saveRDS(LD_basic, file = file.path(dirs$model_output,'LD_basic_MIC.rds'))


#model with NB
LD_NB <- asreml::asreml(fixed = April.lay.date ~ 1 + Fbreeding_age_group,
                random = ~vm(Mother, ped_data_inv) + 
                  ide(Mother, ped_data_inv) +
                  breeding_year + 
                  nest.box,
                data = breed_data)
saveRDS(LD_NB, file = file.path(dirs$model_output,'LD_NB_MIC.rds'))


#without distance matrix
LD_spat <- asreml::asreml(fixed = April.lay.date ~ 1 + Fbreeding_age_group,
                       random = ~vm(Mother, ped_data_inv) + 
                         ide(Mother, ped_data_inv) +
                         vm(Mother2, spatial_matrix) +
                         breeding_year,
                       data = breed_data,
                  workspace = 300e6, pworkspace=300e6)
saveRDS(LD_spat, file = file.path(dirs$model_output,'LD_spat_MIC.rds'))



#model with envir sim matrix
LD_envir <- asreml::asreml(fixed = April.lay.date ~ 1 + Fbreeding_age_group,
                        random = ~vm(Mother, ped_data_inv) + 
                          ide(Mother, ped_data_inv) +
                          vm(Mother2, env_matrix) +
                          breeding_year,
                        data = breed_data,
                  workspace = 300e6, pworkspace=300e6)
saveRDS(LD_envir, file = file.path(dirs$model_output,'LD_envir_MIC.rds'))



# HATCHING DATE -----------------------------------------------------------


#model basic 
HD_basic <- asreml::asreml(fixed = April.hatch.date ~ 1 + Fbreeding_age_group,
                  random = ~vm(Mother, ped_data_inv) + 
                            ide(Mother, ped_data_inv) +
                            breeding_year,
                  data = breed_data)
saveRDS(HD_basic, file = file.path(dirs$model_output,'HD_basic_MIC.rds'))


#model with NB
HD_NB <- asreml::asreml(fixed = April.hatch.date ~ 1 + Fbreeding_age_group,
                random = ~vm(Mother, ped_data_inv) + 
                  ide(Mother, ped_data_inv) +
                  breeding_year + 
                  nest.box,
                data = breed_data)
saveRDS(HD_NB, file = file.path(dirs$model_output,'HD_NB_MIC.rds'))


#without distance matrix
HD_spat <- asreml::asreml(fixed = April.hatch.date ~ 1 + Fbreeding_age_group,
                       random = ~vm(Mother, ped_data_inv) + 
                         ide(Mother, ped_data_inv) +
                         vm(Mother2, spatial_matrix) +
                         breeding_year,
                       data = breed_data,
                  workspace = 300e6, pworkspace=300e6,
                  maxiter = 50)
saveRDS(HD_spat, file = file.path(dirs$model_output,'HD_dist_MIC.rds'))



#model with envir sim matrix
HD_envir <- asreml::asreml(fixed = April.hatch.date ~ 1 + Fbreeding_age_group,
                        random = ~vm(Mother, ped_data_inv) + 
                          ide(Mother, ped_data_inv) +
                          vm(Mother2, env_matrix) +
                          breeding_year,
                        data = breed_data,
                  workspace = 300e6, pworkspace=300e6,
                  maxiter = 50)
saveRDS(HD_envir, file = file.path(dirs$model_output,'HD_envir_MIC.rds'))





```



