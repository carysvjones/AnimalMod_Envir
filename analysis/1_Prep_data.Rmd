---
title: "Preparing Data"
author: "Carys Jones"
date: '2023-01-26'
---

# Dependencies
```{r}
box::use(.. / R / dirs[dirs])
box::use(clean = ../ R / clean_data)
box::use(mods = ../ R / for_models)

box::use(readr[read_csv])
box::use(ggplot2)
box::use(dplyr)
box::use(moments)
box::use(kinship2)
box::use(sf)
box::use(tidyr)
box::use(pedantics)
box::use(magrittr[`%>%`])

```


Script to prepare data for running animal models.
First creating pedigree by merging together breeding and ringing data.
Then taking breeding attempt data and getting local environment for each individual.


PREPARE PEDIGREE


```{r}

# MERGE BREEDING AND RINGING DATA -----------------------------------------

#input clean breeding attempt data 1960-2022
breed <- read.csv(file.path(dirs$data_output, 'LT_breeding_data_greti_bluti_1960_2022.csv'), na.strings=c("", "NA"))
nrow(breed) #41987

#subset to just keep great tits 
breed_gtit <- breed %>% 
  dplyr::filter(Species == 'g')
nrow(breed_gtit) #17214

#quick summaries
nrow(breed_gtit) #17214
length(unique(breed_gtit$Pnum)) #18000
length(unique(breed_gtit$Mother)) #8532
summary(breed_gtit$Mother) #3831 mothers unknown  
length(unique(breed_gtit$Father)) #7216
summary(breed_gtit$Father) #6820


# READ IN - Ringing Data  --------------------------------------------------

ring_all <- read.csv(file.path(dirs$data_output, 'ebmp_database_ringing_record_export_GT&BT_all.csv'),
                  na.strings=c("", "NA"))

#just keep great tits  
ring_gtit <- ring_all %>% 
  dplyr::filter(bto_species_code == 'GRETI') 

#quick summaries
nrow(ring_gtit) #91250
length(unique(ring_gtit$Pnum)) #12686
length(unique(ring_gtit$nb)) #1121  
length(unique(ring_gtit$bto_ring)) #91250


# MERGE - ring and breed  ---------------------------------------

#merge both datasets by Pnum
breed_ring_gtit <- merge(breed_gtit, ring_gtit, by = 'Pnum', all = T) %>%
  #keep only some columns
  dplyr::select(bto_ring, Father, Mother, sex)

#summaries
nrow(breed_ring_gtit) #96695
length(unique(breed_ring_gtit$bto_ring)) #91251
length(unique(breed_ring_gtit$Mother)) #8532
length(unique(breed_ring_gtit$Father)) #7216


# CREATING PEDIGREE ----------------------------------------------------------

#rename columns 
ped_gtit_short <- breed_ring_gtit %>%
  dplyr::rename(id = bto_ring,
         dam = Mother,
         sire = Father)

head(ped_gtit_short)
nrow(ped_gtit_short) #96695

#fix the pedigree - adds any missing individuals to id column and orders it correctly
ped_gtit_short_ext_fix <- pedantics::fixPedigree(ped_gtit_short)
ped_gtit_short_ext_fix <- MasterBayes::orderPed(ped_gtit_short_ext_fix)

#this is the overall huge pedigree!
nrow(ped_gtit_short_ext_fix) #98848
#so can save this here...
write.csv(ped_gtit_short_ext_fix, file = file.path(dirs$data_output,'GTIT-pedigree-full.csv'), row.names = F)



#I myself then keep just those that have a laying date recorded, as that's what is useful for my analysis

#make column for LD with dummy values to say if have LD recorded or not - so I can keep only informative individuals 
ped_gtit_short_ext_fix_LD <- dplyr::mutate(ped_gtit_short_ext_fix, LD_num = 
                                      ifelse(ped_gtit_short_ext_fix$id %in% breed_gtit$Father |
                                             ped_gtit_short_ext_fix$id %in% breed_gtit$Mother, 1, NA))

# subset those with a LD
ped_gtit_final <- ped_gtit_short_ext_fix_LD %>%
  dplyr::filter(!is.na(LD_num)) %>%
  droplevels() %>%
  dplyr::select(id, dam, sire)
nrow(ped_gtit_final) #15745


#get pedigree stats - this take a long time to run 
# pedigree_stats <- pedantics::pedigreeStats(ped_gtit_short_ext_fix, retain = 'informative')
# nrow(pedigree_stats$analyzedPedigree) #14559
# saveRDS(pedigree_stats, file = file.path(dirs$data_output,'GTIT-pedStatSummary-full_output.rds'), row.names = F)

write.csv(ped_gtit_final, file = file.path(dirs$data_output,'GTIT-pedigree-for-asreml.csv'), row.names = F)


```


PREPARE DATA


```{r}
# GREAT TITS --------------------------------------------------------------

# BREEDING DATA ---------------------------------------------------

nrow(breed_gtit) #18000

#get rid of those with experiment codes, no LD and no Mother
breed_gtit_noNA <- breed_gtit %>%
  dplyr::filter(is.na(breed_gtit$Experiment.codes) &
                  !is.na(breed_gtit$April.lay.date))


#why choose to just keep mothers?
#how many have no mother
nrow(subset(breed_gtit_noNA, is.na(Mother))) #3491
nrow(subset(breed_gtit_noNA, is.na(Father))) #6382

#have both parents
nrow(subset(breed_gtit_noNA, !is.na(Mother) & !is.na(Father))) #10419
#have just mother
nrow(subset(breed_gtit_noNA, !is.na(Mother))) #13723
nrow(subset(breed_gtit_noNA, !is.na(Mother) & is.na(Father))) #3304 have no mother but have father
#have jsut father
nrow(subset(breed_gtit_noNA, !is.na(Father))) #10832
nrow(subset(breed_gtit_noNA, !is.na(Father) & is.na(Mother))) #413 have no father but have mother


breed_gtit_noNA <- breed_gtit_noNA %>%
  dplyr::filter(!is.na(Mother)) %>%
  dplyr::select('year', 'Pnum', 'Section', 'April.lay.date', 'April.hatch.date',
                                        'Clutch.size', 'Num.fledglings', 'Father', 'Mother', 'nest.box')
length(unique(breed_gtit_noNA$Mother)) #7792
length(unique(breed_gtit_noNA$Father)) #6342
length(unique(breed_gtit_noNA$Pnum)) #12151
summary(breed_gtit_noNA$April.lay.date) #-5 to 83


nrow(breed_gtit_noNA) #12151


# ADD AGE  ----------------------------------------------------------------

ring <- read.csv(file.path(dirs$data_output, 'ebmp_database_ringing_record_export_GT&BT_all.csv'), na.strings=c("", "NA"))


breed_gtit_noNA_age <- clean$get_age(breed_gtit_noNA, ring)
table(breed_gtit_noNA_age$Fem_breed_age)


# GET RID MOTHER & FATHER KNOWN 2ND BROODS & LATE BROODS ------------------

#use function - decide which ones to use 
#should say how many breeding attempts it gets rid of each time
breed_gtit_noNA_age_sub <- clean$remove_late_broods(breed_gtit_noNA_age, mothers = T, fathers = T, late = T)
nrow(breed_gtit_noNA_age_sub) #11743

#rename year as breeding year - make new column of yearling and adult 
breed_gtit_noNA_age_sub <- breed_gtit_noNA_age_sub %>%
  dplyr::rename('breeding_year' = 'year') %>%
  dplyr::mutate(Fbreeding_age_group = ifelse(Fem_breed_age == 1, 'Yearling', 'Adult')) 
summary(as.factor(breed_gtit_noNA_age_sub$Fbreeding_age_group)) #Adult 4857, Yearling 6886
summary(as.factor(breed_gtit_noNA_age_sub$Fem_breed_age))


```



ADD SPATIAL DATA 


```{r}


#Just open habitat data straight away 

habitat_data <- read.csv(file.path(dirs$data_output, 'Habitat_data_nestboxes.csv'), na.strings = "NA")

# nest_sub <- unique(breed_gtit_noNA_age_sub$nest.box[!(breed_gtit_noNA_age_sub$nest.box %in% habitat_data$Box)])

#now merge with breeding data!
gtit_data_sub_nb <- merge(breed_gtit_noNA_age_sub, habitat_data, by = 'Pnum')
nrow(gtit_data_sub_nb) #11660 - only a few hundred missing from before 

#cropped pop density @ 3 hectares
gtit_data_sub_nb$area_polygon.G_crop3 <- gtit_data_sub_nb$area_polygon.G
gtit_data_sub_nb$area_polygon.G_crop3[gtit_data_sub_nb$area_polygon.G > 30000] <- 30000
summary(gtit_data_sub_nb$area_polygon.G_crop3)


# SPATIAL MATRIX ----------------------------------------------------------

# FINDING MIDPOINT IN SPACE FOR INDIVIDUALS -------------------------------

#data set of all that have nest box
nrow(gtit_data_sub_nb) #11660
length(unique(gtit_data_sub_nb$Mother)) #7595

summary(gtit_data_sub_nb$April.lay.date) #-5 to 59, median = 25
summary(gtit_data_sub_nb$April.hatch.date)#780 NAs
summary(gtit_data_sub_nb$Clutch.size) #43 NAs

#if individuals have multiple breeding attempts
#need to find midpoint location of nest boxes
#so can use that to make matrix of distance between all individuals

#look at how many use >1 box
gtit_data_sub_nb_multisumm <- gtit_data_sub_nb %>%
  dplyr::group_by(., Mother) %>%
  dplyr::summarise(., nest_boxes = length(unique(nest.box)),
            breed_attempts = length(nest.box))
hist(gtit_data_sub_nb_multisumm$nest_boxes)
hist(gtit_data_sub_nb_multisumm$breed_attempts)


#plot these just out of interest to see how far boxes are away from eachother?
###WORK THIS OUT
#just keep breeding attempts for mothers that moved boxes

#subset 3 birds
multi_box <- gtit_data_sub_nb %>%
  dplyr::group_by(., Mother) %>%
  dplyr::filter(length((nest.box)) > 1) %>%
  dplyr::mutate(
    x2 = dplyr::lead(x),
    y2 = dplyr::lead(y), 
    edge2 = dplyr::lead(edge.EDI.),
    alt2 = dplyr::lead(altitude.m.),
    north2 = dplyr::lead(northness),
    trees2 = dplyr::lead(No_trees_75m),
    area2 = dplyr::lead(area_polygon.G_crop3),
    nest.box2 = dplyr::lead(nest.box),
    breeding_year2 = dplyr::lead(breeding_year)) %>%
  
  dplyr::mutate(dist = sqrt((x2 - x)^2 + (y2 - y)^2),
                edge_diff = abs(edge2 - edge.EDI.),
                alt_diff = abs(alt2 - altitude.m.),
                north_diff = abs(north2 - northness),
                tree_diff = abs(trees2 - No_trees_75m), 
                area_diff = abs(area2 - area_polygon.G_crop3)) %>%
  
  dplyr::ungroup() %>%
  dplyr::select(Mother, breeding_year, breeding_year2, x, y , x2, y2, nest.box, nest.box2, dist,
                edge_diff, alt_diff, north_diff, tree_diff, area_diff)


#get rid of distance NA's and 0 distance
nrow(multi_box) #5503
multi_box <- multi_box %>%
  dplyr::filter(!is.na(dist))
nrow(multi_box) #3393

summary(multi_box)
length(unique(multi_box$Mother)) #2559
length(unique(multi_box$Mother)) / length(unique(gtit_data_sub_nb$Mother)) #33.7% mothers breed in multi years

length(unique(subset(multi_box, dist > 0)$Mother)) / length(unique(gtit_data_sub_nb$Mother)) #27.8% breed in diff boxes

#DISTANCES
median(multi_box$dist) #71.7m
mean(multi_box$dist) #109.6m
range(multi_box$dist) #0 - 2647.5m

multi_box_summ <- multi_box %>%
  dplyr::summarise(dist_med = median(dist, na.rm = T), 
                edge_med = median(edge_diff, na.rm = T),
                alt_med = median(alt_diff, na.rm = T),
                north_med = median(north_diff, na.rm = T),
                tree_med = median(tree_diff, na.rm = T),
                area_med = median(area_diff, na.rm = T))

gtit_data_summ <- gtit_data_sub_nb %>%
  dplyr::summarise(edge_med = median(edge.EDI., na.rm = T),
                alt_med = median(altitude.m., na.rm = T),
                north_med = median(northness, na.rm = T),
                tree_med = median(No_trees_75m, na.rm = T),
                area_med = median(area_polygon.G_crop3, na.rm = T))



#MEAN COORDINATES OF NEST BOX FOR MULTI NESTERS
#first make line for each breeding attempt
#then after individual will have same coords for all rows/breeding attempts
#so can then jsut keep one row per individual 

gtit_data_sub_nb <- gtit_data_sub_nb %>%
  dplyr::group_by(Mother) %>%
  dplyr::mutate(x_mean = mean(x),
                y_mean = mean(y),
                alt_mean = mean(altitude.m.),
                northness_mean = mean(northness),
                edge_mean = mean(edge.EDI.),
                No_trees_75m_mean = mean(No_trees_75m),
                area_polygon_crop3_mean = mean(area_polygon.G_crop3)) %>%
  dplyr::ungroup()

unique(gtit_data_sub_nb$breeding_year)
#output data
write.csv(gtit_data_sub_nb, file = file.path(dirs$data_output,'GTIT_data_anim_mod.csv'), row.names = F)


```


